document.addEventListener("DOMContentLoaded",function(){const indexerButtons=document.querySelectorAll(".isc-indexer-btn");const progressBar=document.getElementById("isc-indexer-progress-bar");const statusText=document.getElementById("isc-indexer-status");const progressDiv=document.getElementById("isc-indexer-progress");const progressStats=document.querySelector(".isc-indexer-progress-stats");const resultsDiv=document.getElementById("isc-indexer-results");const resultsTbody=document.getElementById("isc-indexer-results-tbody");const summaryDiv=document.getElementById("isc-indexer-summary");const summaryText=document.getElementById("isc-indexer-summary-text");let isIndexing=false;let processedItems=[];let totalItems=0;let urlBatchSize=100;let currentGlobalOffset=0;let currentUrlBatch=[];let currentUrlBatchIndex=0;let startTimestamp=0;let currentIndexingMode="all";function initEventListeners(){indexerButtons.forEach(function(button){button.addEventListener("click",function(){if(!isIndexing){currentIndexingMode=button.getAttribute("data-isc-indexer-mode")||"all";startIndexing()}})})}function startIndexing(){processedItems=[];resultsTbody.innerHTML="";resultsDiv.classList.add("hidden");summaryDiv.classList.add("hidden");statusText.textContent="";startTimestamp=Math.floor(Date.now()/1e3);isIndexing=true;indexerButtons.forEach(function(button){button.disabled=true});progressDiv.classList.remove("hidden");getTotalCount()}function getTotalCount(){const formData=new FormData;formData.append("action","isc_get_indexer_total");formData.append("nonce",isc.ajaxNonce);formData.append("indexing_mode",currentIndexingMode);fetch(ajaxurl,{method:"POST",credentials:"same-origin",body:formData}).then(response=>{if(!response.ok){throw new Error("Network response was not ok")}return response.json()}).then(data=>{if(data.success){totalItems=data.data.total;currentGlobalOffset=0;currentUrlBatch=[];currentUrlBatchIndex=0;if(totalItems===0){statusText.textContent="No content to index.";completeIndexing();return}fetchNextBatch(0)}else{handleError(data.data)}}).catch(error=>{handleError("Failed to get total count: "+error.message)})}function fetchNextBatch(offset){const formData=new FormData;formData.append("action","isc_get_indexer_batch");formData.append("nonce",isc.ajaxNonce);formData.append("offset",offset);formData.append("batch_size",urlBatchSize);formData.append("indexing_mode",currentIndexingMode);fetch(ajaxurl,{method:"POST",credentials:"same-origin",body:formData}).then(response=>{if(!response.ok){throw new Error("Network response was not ok")}return response.json()}).then(data=>{if(data.success){currentUrlBatch=data.data.urls;currentUrlBatchIndex=0;if(currentUrlBatch.length===0){completeIndexing();return}processNextItemInBatch()}else{handleError(data.data)}}).catch(error=>{handleError("Failed to fetch batch: "+error.message);completeIndexing()})}function processNextItemInBatch(){if(currentGlobalOffset>=totalItems){completeIndexing();return}if(currentUrlBatchIndex>=currentUrlBatch.length){fetchNextBatch(currentGlobalOffset);return}const urlData=currentUrlBatch[currentUrlBatchIndex];runIndexer(urlData,currentGlobalOffset)}function runIndexer(urlData,globalOffset){progressStats.textContent=iscIndexerL10n.processingPages.replace("%1$s",globalOffset+1).replace("%2$s",totalItems);const formData=new FormData;formData.append("action","isc_run_indexer");formData.append("nonce",isc.ajaxNonce);formData.append("url_data",JSON.stringify(urlData));formData.append("global_offset",globalOffset);fetch(ajaxurl,{method:"POST",credentials:"same-origin",body:formData}).then(response=>{if(!response.ok){throw new Error("Network response was not ok")}return response.json()}).then(data=>{if(data.success){processedItems.push(data.data);updateResultsList([data.data]);progressBar.value=Math.min(100,Math.round((globalOffset+1)/totalItems*100));currentGlobalOffset++;currentUrlBatchIndex++;processNextItemInBatch()}else{handleError(data.data)}}).catch(error=>{handleError("Processing item failed: "+error.message);completeIndexing()})}function updateResultsList(items){if(resultsDiv.classList.contains("hidden")){resultsDiv.classList.remove("hidden")}items.forEach(item=>{const row=document.createElement("tr");const titleCell=document.createElement("td");const link=document.createElement("a");link.href=item.url;link.target="_blank";link.textContent=item.title;titleCell.appendChild(link);row.appendChild(titleCell);const postTypeCell=document.createElement("td");postTypeCell.textContent=getPostTypeName(item.post_type);row.appendChild(postTypeCell);const imagesCountCell=document.createElement("td");imagesCountCell.textContent=item.images_count;row.appendChild(imagesCountCell);resultsTbody.appendChild(row)})}function getPostTypeName(postType){if(iscIndexerL10n.postTypes[postType]){return iscIndexerL10n.postTypes[postType]}return postType.replace(/-/g," ").replace(/\b\w/g,c=>c.toUpperCase())}function enableIndexerButtons(){isIndexing=false;indexerButtons.forEach(function(button){button.disabled=false})}function completeIndexing(){enableIndexerButtons();statusText.textContent=iscIndexerL10n.indexingComplete;const totalImages=processedItems.reduce((total,item)=>total+item.images_count,0);summaryText.textContent=iscIndexerL10n.processedSummary.replace("%1$s",processedItems.length).replace("%2$s",totalImages);summaryDiv.classList.remove("hidden");if(!resultsDiv.classList.contains("hidden")){resultsDiv.insertBefore(summaryDiv,resultsDiv.firstChild)}if(currentIndexingMode==="all"){cleanupIndex()}updateStatusTable()}function cleanupIndex(){const formData=new FormData;formData.append("action","isc_cleanup_indexer");formData.append("nonce",isc.ajaxNonce);formData.append("start_time",startTimestamp);formData.append("indexing_mode",currentIndexingMode);fetch(ajaxurl,{method:"POST",credentials:"same-origin",body:formData}).then(response=>response.json()).then(data=>{if(!data.success){console.error("Cleanup failed",data.data)}}).catch(error=>{console.error("Cleanup error",error)})}function updateStatusTable(){const formData=new FormData;formData.append("action","isc_get_indexer_status");formData.append("nonce",isc.ajaxNonce);fetch(ajaxurl,{method:"POST",credentials:"same-origin",body:formData}).then(response=>{if(!response.ok){throw new Error("Network response was not ok")}return response.json()}).then(data=>{if(data.success){const statusTableBody=document.querySelector(".isc-indexer-status-table tbody");if(statusTableBody){statusTableBody.innerHTML=data.data.tbody_html;const newIndexerButtons=statusTableBody.querySelectorAll(".isc-indexer-btn");newIndexerButtons.forEach(function(button){button.addEventListener("click",function(){if(!isIndexing){currentIndexingMode=button.getAttribute("data-isc-indexer-mode")||"all";startIndexing()}})})}}else{console.error("Failed to update status table:",data.data)}}).catch(error=>{console.error("Error updating status table:",error)})}function handleError(message){statusText.textContent=iscIndexerL10n.error+": "+message;enableIndexerButtons()}initEventListeners()});